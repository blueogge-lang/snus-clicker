<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hjalmars Snus Factory</title>
<style>
body {
    margin:0;
    font-family: Arial, sans-serif;
    display:flex;
    height:100vh;
    background: linear-gradient(#235027, #474334);
    overflow:hidden;
}
#leftPanel {
    flex:2;
    display:flex;
    flex-direction:column;
    align-items:center;
    position:relative;
}
#cookieCount {
    font-size:2.2em;
    margin-top:20px;
    text-shadow:1px 1px 2px #aaa;
}
#cpsCount {
    font-size:1.2em;
    margin-bottom:20px;
}
#clickImg {
    width:300px;
    cursor:pointer;
    transition:0.1s;
    border-radius:50%;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
#clickImg:active {
    transform:scale(0.95);
}
#cursorContainer {
    position:absolute;
    width:400px;
    height:400px;
    top:150px;
    pointer-events:none;
}
.floatingNumber {
    position:absolute;
    font-size:20px;
    font-weight:bold;
    color:#ff4500;
    pointer-events:none;
    animation:floating 1s ease-out forwards;
}
@keyframes floating {
    0% { opacity:1; transform:translateY(0px); }
    100% { opacity:0; transform:translateY(-50px); }
}
#nameInput { margin-top:20px; }
#rightPanel {
    flex:1;
    background:#eee;
    padding:20px;
    overflow-y:auto;
    border-left:2px solid #ddd;
}
.shopItem, .upgradeItem, .rebirthItem {
    background:#fff;
    padding:10px;
    margin:10px 0;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    transition:0.2s;
}
.shopItem:hover, .upgradeItem:hover, .rebirthItem:hover {
    transform:scale(1.02);
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
#upgradesTab {
    background:#ccc;
    padding:10px;
    margin-bottom:10px;
    cursor:pointer;
    text-align:center;
    border-radius:5px;
}
#upgradesPanel { display:none; margin-bottom:20px; }
#statsPanel {
    background:#fff;
    padding:10px;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
    margin-top:20px;
}
#adminPanel {
    background:#ffdddd;
    padding:10px;
    margin-top:20px;
    display:none;
    border:2px solid red;
}
button {
    margin:5px 0;
    padding:5px 10px;
    border-radius:5px;
    cursor:pointer;
}
#adminPanel input { width:120px; margin-right:5px; }
#offlinePopup {
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    top:20px;
    background:rgba(0,0,0,0.85);
    color:#fff;
    padding:12px 18px;
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    font-weight:bold;
    display:none;
    z-index:9999;
}
</style>
</head>
<body>

<div id="leftPanel">
<h1>Hjalmars Snus Factory</h1>
<div id="cookieCount">0 Snus</div>
<div id="cpsCount">0 Snus/sec</div>
<img id="clickImg" src="snus.png" alt="Snus">
<div id="cursorContainer"></div>
<div id="nameInput">
<input type="text" id="playerName" placeholder="Enter your name">
<button onclick="setName()">Set Name</button>
</div>
</div>

<div id="rightPanel">
<div id="upgradesTab" onclick="toggleUpgrades()">Upgrades ▼</div>
<div id="upgradesPanel"></div>
<h2>Shop</h2>
<div id="shopItems"></div>
<div class="rebirthItem" onclick="prestige()">Prestige (Convert Snus to points)</div>
<div id="statsPanel">
<h3>Stats</h3>
<p id="totalCookiesStat">Total Snus: 0</p>
<p id="clicksStat">Total Clicks: 0</p>
<p id="prestigeStat">Prestige Points: 0</p>
</div>
<div id="adminPanel">
<h3>Admin Panel</h3>
<input type="text" id="adminCookieInput" placeholder="Amount">
<button onclick="adminAddCustomSnus()">Add Snus</button>
<button onclick="adminRemoveSnus()">Remove Snus</button>
<button onclick="adminMultiplySnus()">×10 Snus</button>
<button onclick="adminSetCPS()">Set SPS</button>
<button onclick="adminGiveAllItems()">Give All Items</button>
<button onclick="adminMaxUpgrades()">Max Upgrades</button>
<button onclick="startClickFrenzy()">Click Frenzy ×777</button>
<button onclick="stopClickFrenzy()">Stop Click Frenzy</button>
<button onclick="startSnusFrenzy()">Snus Frenzy ×100</button>
<button onclick="stopSnusFrenzy()">Stop Snus Frenzy</button>
<button onclick="adminAddPrestige()">Add Prestige</button>
<button onclick="toggleAutoBuy()">Auto-Buy Items</button>
<button onclick="toggleAutoUpgrade()">Auto-Buy Upgrades</button>
<button onclick="toggleFreeze()">Freeze SPS</button>
<button onclick="resetGame()">Reset Game</button>
</div>
</div>

<div id="offlinePopup"></div>

<script>
// --- Format Numbers ---
function formatNumber(n){
    if(n < 1e3) return n.toFixed(0);
    if(n < 1e6) return (n/1e3).toFixed(2)+"K";
    if(n < 1e9) return (n/1e6).toFixed(2)+"M";
    if(n < 1e12) return (n/1e9).toFixed(2)+"B";
    return n.toExponential(2);
}

// --- Game Variables ---
let score=0, totalSnus=0, baseClickValue=1, clicksMade=0, rebirthMult=1, cpsExtraBase=0, prestigePoints=0, playerName="";
let clickMultiplier=1, cpsMultiplier=1;
let clickFrenzyActive=false, snusFrenzyActive=false, autoBuyItems=false, autoBuyUpgrades=false, freezeCPS=false;

// --- Shop Items ---
// Added items requested by user (XQS, CUBA, PABLO, EPOK, VELO, killa, greatest, rabbit, glitch)
// Kept original items as well; all entries include baseCps, cps, baseCost, cost, owned
const items=[
  {name:"XQS", baseCps:0.4, cps:0.4, baseCost:15, cost:15, owned:0},
  {name:"CUBA", baseCps:5, cps:5, baseCost:100, cost:100, owned:0},
  {name:"PABLO", baseCps:8, cps:8, baseCost:1100, cost:1100, owned:0},
  {name:"EPOK", baseCps:16, cps:16, baseCost:3000, cost:3000, owned:0},
  {name:"VELO", baseCps:32, cps:32, baseCost:100, cost:100, owned:0},
  // original item kept (case-different)
  {name:"Velo", baseCps:64, cps:64, baseCost:100, cost:100, owned:0},
  {name:"Zyn", baseCps:128, cps:128, baseCost:1000, cost:1000, owned:0},
  {name:"Loop", baseCps:256, cps:256, baseCost:3000, cost:3000, owned:0},
  {name:"Puck", baseCps:578, cps:578, baseCost:10000, cost:10000, owned:0},
  {name:"killa", baseCps:1283, cps:1283, baseCost:50000, cost:50000, owned:0},
  {name:"greatest", baseCps:2742, cps:2742, baseCost:200000, cost:200000, owned:0},
  {name:"rabbit", baseCps:5638, cps:5638, baseCost:750000, cost:750000, owned:0},
  {name:"glitch", baseCps:10432, cps:10432, baseCost:2500000, cost:2500000, owned:0}
];

// --- Item Upgrades ---
// changed to use baseCost and applied count for scaling
let itemUpgrades=[];
items.forEach(item=>{
    for(let i=1;i<=5;i++){
        itemUpgrades.push({
            item:item.name,
            level:i,
            name:item.name+" Upgrade "+i,
            baseCost: Math.floor(item.baseCost*10*i),
            applied:0, // number of times bought
            // effect multiplies the specific item's cps; will be applied 'applied' times on load
            effect:()=>{ const it=items.find(it=>it.name===item.name); if(it) it.cps*=1.5; },
            requiredOwned: i===1 ? 5 : i*10
        });
    }
});

// --- General Upgrades ---
// changed to be repeatable (applied: number) with baseCost for scaling
let generalUpgrades=[
  {name:"Double Click Power", baseCost:1000, applied:0, effect:()=>{baseClickValue*=2;}},
  {name:"+10 Click Power", baseCost:5000, applied:0, effect:()=>{baseClickValue+=10;}},
  {name:"Cursor Bonus SPS", baseCost:7000, applied:0, effect:()=>{cpsExtraBase+=5;}}
];

// --- Elements ---
const counter=document.getElementById("cookieCount");
const cpsCounter=document.getElementById("cpsCount");
const clickImgElem=document.getElementById("clickImg");
const playerNameInput=document.getElementById("playerName");
const shopItemsDiv=document.getElementById("shopItems");
const upgradesPanel=document.getElementById("upgradesPanel");
const adminPanelElem=document.getElementById("adminPanel");
const offlinePopup=document.getElementById("offlinePopup");

// --- Floating Numbers ---
function createFloatingNumber(x,y,text){
    const div=document.createElement("div");
    div.className="floatingNumber";
    div.style.left=(x-10)+"px";
    div.style.top=(y-10)+"px";
    div.textContent=text;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),1000);
}
function createFloatingNumberFromElem(elem,text){
    const rect=elem.getBoundingClientRect();
    createFloatingNumber(rect.left+rect.width/2, rect.top, text);
}
function showOfflinePopup(text){
    offlinePopup.textContent=text;
    offlinePopup.style.display='block';
    offlinePopup.style.opacity='1';
    setTimeout(()=>{
        offlinePopup.style.transition='opacity 0.6s ease';
        offlinePopup.style.opacity='0';
        setTimeout(()=>offlinePopup.style.display='none',600);
    },5000);
}

// --- Update UI ---
function updateUI(){
    counter.textContent=formatNumber(score)+" Snus";
    cpsCounter.textContent=formatNumber(getTotalSPS()*cpsMultiplier)+" Snus/sec";
    renderShop();
    renderUpgrades();
    updateStats();
}

// --- Shop ---
function renderShop(){
    shopItemsDiv.innerHTML="";
    items.forEach((item,i)=>{
        const div=document.createElement("div");
        div.className="shopItem";
        div.textContent=`${item.name} - SPS: ${formatNumber(item.cps)} - Cost: ${formatNumber(Math.floor(item.cost))} - Owned: ${item.owned}`;
        div.onclick=()=>buyItem(i,div);
        shopItemsDiv.appendChild(div);
    });
}

function buyItem(i,elem){
    if(score>=items[i].cost){
        score-=items[i].cost;
        items[i].owned++;
        items[i].cost=Math.floor(items[i].cost*1.15);
        createFloatingNumberFromElem(elem,"+Item");
        updateUI();
    }
}

// --- Click ---
clickImgElem.addEventListener("click",(e)=>{
    const clickValue=baseClickValue*clickMultiplier*rebirthMult;
    score+=clickValue;
    totalSnus+=clickValue;
    clicksMade++;
    createFloatingNumber(e.clientX,e.clientY,"+"+formatNumber(clickValue));
    updateUI();
});

// --- CPS Loop ---
setInterval(()=>{
    if(!freezeCPS){
        const sps=getTotalSPS()*cpsMultiplier;
        score+=sps/60;
        totalSnus+=sps/60;
        updateUI();
    }
},1000/60);

// --- Upgrades ---
function toggleUpgrades(){ upgradesPanel.style.display=upgradesPanel.style.display==="none"?"block":"none"; renderUpgrades(); }
function renderUpgrades(){
    upgradesPanel.innerHTML="";
    // consolidated: both generalUpgrades and itemUpgrades now use baseCost and applied counts
    [...generalUpgrades,...itemUpgrades].forEach(up=>{
        const div=document.createElement("div");
        div.className="upgradeItem";
        let canBuy=true;
        if(up.item) {
            const owned=findItem(up.item)?.owned || 0;
            canBuy=owned>=up.requiredOwned;
        }
        // price scales with how many times bought
        const price = up.baseCost ? Math.floor(up.baseCost * Math.pow(1.5, up.applied)) : Math.floor(up.cost * Math.pow(1.5, up.applied));
        // show how many times purchased (if >0)
        const purchasedText = up.applied && up.applied > 0 ? ` (bought x${up.applied})` : "";
        div.textContent=`${up.name} - Cost: ${formatNumber(price)}${up.item?' (Requires '+up.requiredOwned+' '+up.item+')':''}${purchasedText}`;
        div.style.opacity=canBuy?"1":"0.5";
        div.onclick=()=>{
            if(score>=price && canBuy){
                score-=price;
                // increment applied correctly for both general and item upgrades
                up.applied = (typeof up.applied === 'number') ? up.applied + 1 : 1;
                // apply the effect once for this purchase
                up.effect();
                createFloatingNumberFromElem(div,"+Upgrade");
                updateUI();
            }
        };
        upgradesPanel.appendChild(div);
    });
}

// --- Stats ---
function updateStats(){
    document.getElementById("totalCookiesStat").textContent="Total Snus: "+formatNumber(totalSnus);
    document.getElementById("clicksStat").textContent="Total Clicks: "+clicksMade;
    document.getElementById("prestigeStat").textContent="Prestige Points: "+prestigePoints;
}

// --- Total SPS ---
function getTotalSPS(){ return items.reduce((acc,it)=>acc+it.cps*it.owned,0)+cpsExtraBase; }
function findItem(name){ return items.find(it=>it.name===name); }

// --- Name ---
function setName(){
    playerName=playerNameInput.value;
    adminPanelElem.style.display=(playerName.toLowerCase()==="hjalmarprimemode")?"block":"none";
    document.title=playerName+" - Hjalmars Snus Factory";
    alert("Welcome, "+playerName+"!");
}

// --- Prestige ---
function prestige(){
    if(score>=100000){
        const points=Math.floor(score/100000);
        prestigePoints+=points;
        rebirthMult*=1.5;
        score=0; totalSnus=0;
        items.forEach(it=>{it.owned=0; it.cps=it.baseCps; it.cost=it.baseCost;});
        itemUpgrades.forEach(up=>up.applied=0);
        generalUpgrades.forEach(up=>up.applied=0);
        baseClickValue=1; cpsExtraBase=0; clickMultiplier=1; cpsMultiplier=1;
        createFloatingNumber(window.innerWidth/2,150,"+Prestige");
        updateUI();
        alert(`You gained ${points} prestige points! Multiplier now x${rebirthMult.toFixed(2)}`);
    } else alert("You need at least 100,000 Snus to rebirth!");
}

// --- Auto-buy ---
setInterval(()=>{
    if(autoBuyItems) items.forEach((it,i)=>{ if(score>=it.cost) buyItem(i); });
    if(autoBuyUpgrades) [...generalUpgrades,...itemUpgrades].forEach(up=>{
        let canBuy=true;
        if(up.item) canBuy=(findItem(up.item)?.owned||0)>=up.requiredOwned;
        const price = up.baseCost ? Math.floor(up.baseCost * Math.pow(1.5, up.applied)) : Math.floor(up.cost * Math.pow(1.5, up.applied));
        // allow repeatable purchases for general upgrades and item upgrades
        if(score>=price && canBuy){
            score-=price;
            up.applied = (typeof up.applied === 'number') ? up.applied + 1 : 1;
            up.effect();
            updateUI();
        }
    });
},500);

// --- Admin Functions ---
function adminAddCustomSnus(){let val=parseFloat(prompt("Enter amount:")); if(!isNaN(val)){score+=val; updateUI();}}
function adminRemoveSnus(){let val=parseFloat(prompt("Remove amount:")); if(!isNaN(val)){score-=val; if(score<0)score=0; updateUI();}}
function adminMultiplySnus(){score*=10; updateUI();}
function adminSetCPS(){let val=parseFloat(prompt("Set SPS:")); if(!isNaN(val)) cpsExtraBase=val;}
function adminGiveAllItems(){items.forEach(it=>it.owned+=10); updateUI();}
function adminMaxUpgrades(){
    // grant some number of upgrades; set applied and re-run effects accordingly
    [...generalUpgrades,...itemUpgrades].forEach(up=>{
        // if it's a number applied, set to e.g. 5 purchases
        if(typeof up.applied === 'number'){
            // to avoid stacking effect multiple times, first reset then apply
            // We can't reliably undo effects, so we simply apply N times from current state
            const timesToGive = 5 - up.applied;
            if(timesToGive > 0){
                for(let i=0;i<timesToGive;i++){
                    up.applied++;
                    up.effect();
                }
            }
        } else {
            // legacy fallback
            up.applied = 1;
            up.effect();
        }
    });
    updateUI();
}
function startClickFrenzy(){ if(!clickFrenzyActive){ clickFrenzyActive=true; clickMultiplier*=777; setTimeout(stopClickFrenzy,30000); } }
function stopClickFrenzy(){ if(clickFrenzyActive){ clickFrenzyActive=false; clickMultiplier/=777; } }
function startSnusFrenzy(){ if(!snusFrenzyActive){ snusFrenzyActive=true; cpsMultiplier*=100; setTimeout(stopSnusFrenzy,30000); } }
function stopSnusFrenzy(){ if(snusFrenzyActive){ snusFrenzyActive=false; cpsMultiplier/=100; } }
function adminAddPrestige(){ let val=parseInt(prompt("Add prestige points:")); if(!isNaN(val)){ prestigePoints+=val; updateStats(); } }
function toggleAutoBuy(){autoBuyItems=!autoBuyItems;}
function toggleAutoUpgrade(){autoBuyUpgrades=!autoBuyUpgrades;}
function toggleFreeze(){freezeCPS=!freezeCPS;}
function resetGame(){ if(confirm("Reset all progress?")){ localStorage.removeItem('snusGameState'); location.reload(); } }

// --- Save/Load ---
function saveGameState(){
    const state={
        score,
        totalSnus,
        clicksMade,
        prestigePoints,
        items:items.map(it=>({name:it.name,owned:it.owned,cost:it.cost})),
        itemUpgrades:itemUpgrades.map(u=>({name:u.name,applied:u.applied})),
        generalUpgrades:generalUpgrades.map(u=>({name:u.name,applied:u.applied})),
        baseClickValue,
        cpsExtraBase,
        lastSaved:Date.now()
    };
    localStorage.setItem('snusGameState',JSON.stringify(state));
}
function loadGameState(){
    const raw=localStorage.getItem('snusGameState'); if(!raw) return;
    const state=JSON.parse(raw);
    score=state.score??score;
    totalSnus=state.totalSnus??totalSnus;
    clicksMade=state.clicksMade??clicksMade;
    prestigePoints=state.prestigePoints??prestigePoints;
    baseClickValue=state.baseClickValue??baseClickValue;
    cpsExtraBase=state.cpsExtraBase??cpsExtraBase;
    if(state.items) state.items.forEach(saved=>{
        const it=items.find(x=>x.name===saved.name);
        if(it){it.owned=saved.owned; it.cost=saved.cost;}
    });
    if(state.itemUpgrades) state.itemUpgrades.forEach(saved=>{
        const up=itemUpgrades.find(x=>x.name===saved.name);
        if(up) up.applied=saved.applied;
    });
    if(state.generalUpgrades) state.generalUpgrades.forEach(saved=>{
        const up=generalUpgrades.find(x=>x.name===saved.name);
        if(up) up.applied=saved.applied;
    });
    // Reapply effects according to applied counts (apply effect up.applied times)
    [...generalUpgrades,...itemUpgrades].forEach(up=>{
        if(up.applied && typeof up.applied === 'number' && up.applied>0){
            for(let i=0;i<up.applied;i++){
                try{ up.effect(); } catch(e){ console.error("Error applying upgrade effect:", up.name, e); }
            }
        }
    });
    if(state.lastSaved){
        const gain=getTotalSPS()*(Date.now()-state.lastSaved)/1000*cpsMultiplier;
        if(gain>0){score+=gain; totalSnus+=gain; showOfflinePopup('+'+formatNumber(gain)+' Snus (offline)');}
    }
}
window.addEventListener('beforeunload', saveGameState);
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden') saveGameState(); else { loadGameState(); updateUI(); } });

// --- Load ---
loadGameState();
updateUI();
</script>
</body>
</html>
