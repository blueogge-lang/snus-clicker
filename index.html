<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hjalmars Snus Factory (Fixed)</title>
<style>
body{margin:0;font-family: Arial, sans-serif;display:flex;height:100vh;background: linear-gradient(#f8f4e3,#f0e9d2);overflow:hidden;}
#leftPanel{flex:2;display:flex;flex-direction:column;align-items:center;justify-content:start;padding:20px;position:relative;}
#cookieCount{font-size:2.2em;margin-top:20px;text-shadow:1px 1px 2px #aaa;}
#cpsCount{font-size:1.2em;margin-bottom:20px;}
#clickImg{width:300px;cursor:pointer;transition:0.1s;border-radius:50%;box-shadow:0 5px 15px rgba(0,0,0,0.3);} 
#clickImg:active{transform:scale(0.95);}
#cursorContainer{position:absolute;width:400px;height:400px;top:150px;pointer-events:none;}
.cursor{position:absolute;width:50px;height:50px;background:url('https://upload.wikimedia.org/wikipedia/commons/7/76/Mouse-pointer.svg') no-repeat center/contain;}
.floatingNumber{position:absolute;font-size:20px;font-weight:bold;color:#ff4500;pointer-events:none;animation:floating 1s ease-out forwards;}
@keyframes floating{0%{opacity:1;transform:translateY(0px);}100%{opacity:0;transform:translateY(-50px);}}
#nameInput{margin-top:20px;}
#rightPanel{flex:1;background:#eee;padding:20px;overflow-y:auto;border-left:2px solid #ddd;}
.shopItem,.upgradeItem,.rebirthItem{background:#fff;padding:10px;margin:10px 0;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);cursor:pointer;display:flex;align-items:center;transition:0.2s;}
.shopItem:hover,.upgradeItem:hover,.rebirthItem:hover{transform:scale(1.02);box-shadow:0 4px 10px rgba(0,0,0,0.2);}
#upgradesTab{background:#ccc;padding:10px;margin-bottom:10px;cursor:pointer;text-align:center;border-radius:5px;}
#upgradesPanel{display:none;margin-bottom:20px;}
#statsPanel{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);margin-top:20px;}
#adminPanel{background:#ffdddd;padding:10px;margin-top:20px;display:none;border:2px solid red;}
button{margin:5px 0;padding:5px 10px;border-radius:5px;cursor:pointer;}
#adminPanel input{width:120px;margin-right:5px;}
/* Offline popup */
#offlinePopup{position:fixed;left:50%;transform:translateX(-50%);top:20px;background:rgba(0,0,0,0.85);color:#fff;padding:12px 18px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-weight:bold;display:none;z-index:9999;}
</style>
</head>
<body>
<div id="leftPanel">
<h1>Hjalmars Snus Factory</h1>
<div id="cookieCount">0.000 Cookies</div>
<div id="cpsCount">0.000 cookies/sec</div>
<img id="clickImg" src="snus.png" alt="Cookie">
<div id="cursorContainer"></div>
<div id="nameInput">
<input type="text" id="playerName" placeholder="Enter your name">
<button onclick="setName()">Set Name</button>
</div>
</div>


<div id="rightPanel">
<div id="upgradesTab" onclick="toggleUpgrades()">Upgrades ▼</div>
<div id="upgradesPanel"></div>
<h2>Shop</h2>
<div id="shopItems"></div>
<div class="rebirthItem" onclick="prestige()">Prestige (Convert cookies to points)</div>
<div id="statsPanel">
<h3>Stats</h3>
<p id="totalCookiesStat">Total Cookies: 0.000</p>
<p id="clicksStat">Total Clicks: 0</p>
<p id="prestigeStat">Prestige Points: 0</p>
</div>
<div id="adminPanel">
<h3>Admin Panel</h3>
<input type="text" id="adminCookieInput" placeholder="Amount">
<button onclick="adminAddCustomCookies()">Add Cookies</button>
<button onclick="adminRemoveCookies()">Remove Cookies</button>
<button onclick="adminMultiplyCookies()">×10 Cookies</button>
<button onclick="adminSetCPS()">Set CPS</button>
<button onclick="adminGiveAllItems()">Give All Items</button>
<button onclick="adminMaxUpgrades()">Max Upgrades</button>
<button onclick="startClickFrenzy()">Click Frenzy ×777</button>
<button onclick="stopClickFrenzy()">Stop Click Frenzy</button>
<button onclick="startCookieFrenzy()">Cookie Frenzy ×100</button>
<button onclick="stopCookieFrenzy()">Stop Cookie Frenzy</button>
<button onclick="adminAddPrestige()">Add Prestige</button>
<button onclick="toggleAutoBuy()">Auto-Buy Items</button>
<button onclick="toggleAutoUpgrade()">Auto-Buy Upgrades</button>
<button onclick="toggleFreeze()">Freeze CPS</button>
<button onclick="resetGame()">Reset Game</button>
</div>
</div>

<div id="offlinePopup"></div>


<script>
// --- Format Numbers (3 decimals) ---
function formatNumber(n){
 if(n < 1e3) return n.toFixed(3);
 if(n < 1e6) return (n/1e3).toFixed(3)+"K";
 if(n < 1e9) return (n/1e6).toFixed(3)+"M";
 if(n < 1e12) return (n/1e9).toFixed(3)+"B";
 if(n < 1e15) return (n/1e12).toFixed(3)+"T";
 if(n < 1e18) return (n/1e15).toFixed(3)+"Qa";
 if(n < 1e21) return (n/1e18).toFixed(3)+"Qi";
 return n.toExponential(3);
}


// --- Game Variables ---
let score=0,totalCookies=0,baseClickValue=1,clicksMade=0,rebirthMult=1,cpsExtraBase=0,prestigePoints=0,playerName="";
let cursorOwned=0,clickFrenzyActive=false,cookieFrenzyActive=false,autoBuyItems=false,autoBuyUpgrades=false,freezeCPS=false;
let clickMultiplier = 1; // frenzies multiply this
let cpsMultiplier = 1;   // frenzies multiply this

// --- Shop Items ---
const items = [
  {name:"Velo", baseCps:2.723, cps:2.723, baseCost:100, cost:100, owned:0},
  {name:"Zyn", baseCps:15.482, cps:15.482, baseCost:1000, cost:1000, owned:0},
  {name:"Loop", baseCps:37.856, cps:37.856, baseCost:3000, cost:3000, owned:0},
  {name:"Puck", baseCps:102.459, cps:102.459, baseCost:10000, cost:10000, owned:0},
  {name:"Siberia", baseCps:423.786, cps:423.786, baseCost:40000, cost:40000, owned:0},
  {name:"Greatest", baseCps:1087.345, cps:1087.345, baseCost:100000, cost:100000, owned:0},
  {name:"Odens", baseCps:5123.982, cps:5123.982, baseCost:500000, cost:500000, owned:0},
  {name:"Iceberg", baseCps:10023.456, cps:10023.456, baseCost:1000000, cost:1000000, owned:0},
  {name:"Cuba", baseCps:40078.234, cps:40078.234, baseCost:4000000, cost:4000000, owned:0},
  {name:"Pablo", baseCps:200123.987, cps:200123.987, baseCost:10000000, cost:10000000, owned:0}
];


// --- Helper to find item by name ---
function findItem(name){ return items.find(it => it.name === name); }

// --- Item Upgrades ---
let itemUpgrades=[
 {item:"Velo",name:"Double power",cost:5000,applied:false,effect:()=>{const it=findItem('Velo'); if(it) it.cps*=2;}},
 {item:"Zyn",name:"Double power",cost:10000,applied:false,effect:()=>{const it=findItem('Zyn'); if(it) it.cps*=2;}},
 {item:"Loop",name:"Loop i Loop",cost:15000,applied:false,effect:()=>{const it=findItem('Loop'); if(it) it.cps*=3;}},
 {item:"Puck",name:"Hockey Puck",cost:50000,applied:false,effect:()=>{const it=findItem('Puck'); if(it) it.cps*=2;}},
 {item:"Siberia",name:"Immigrant",cost:100000,applied:false,effect:()=>{const it=findItem('Siberia'); if(it) it.cps*=2;}},
 {item:"Greatest",name:"The Best",cost:300000,applied:false,effect:()=>{const it=findItem('Greatest'); if(it) it.cps*=2;}},
 {item:"Odens",name:"Godly",cost:600000,applied:false,effect:()=>{const it=findItem('Odens'); if(it) it.cps*=2;}},
 {item:"Iceberg",name:"Icy",cost:1200000,applied:false,effect:()=>{const it=findItem('Iceberg'); if(it) it.cps*=3;}},
 {item:"Cuba",name:"Espana",cost:2400000,applied:false,effect:()=>{const it=findItem('Cuba'); if(it) it.cps*=2;}},
 {item:"Pablo",name:"Devils Snus",cost:4800000,applied:false,effect:()=>{const it=findItem('Pablo'); if(it) it.cps*=2;}}
];

let generalUpgrades=[
 {name:"Double Click Power",cost:1000,applied:false,effect:()=>{baseClickValue*=2;}},
 {name:" +10 Click Power",cost:5000,applied:false,effect:()=>{baseClickValue+=10;}},
 {name:"Cursor Bonus CPS",cost:7000,applied:false,effect:()=>{cpsExtraBase+=5;}}
];


// --- Elements ---
const counter=document.getElementById("cookieCount");
const cpsCounter=document.getElementById("cpsCount");
const clickImgElem=document.getElementById("clickImg");
const playerNameInput=document.getElementById("playerName");
const adminPanelElem=document.getElementById("adminPanel");
const shopItemsDiv=document.getElementById("shopItems");
const upgradesPanel=document.getElementById("upgradesPanel");
const cursorContainer=document.getElementById("cursorContainer");
const offlinePopup=document.getElementById('offlinePopup');


// --- Floating Numbers ---
function createFloatingNumber(x,y,text){
 const div=document.createElement("div");
 div.className="floatingNumber";
 div.style.left=(x-10)+"px";
 div.style.top=(y-10)+"px";
 div.textContent=text;
 document.body.appendChild(div);
 setTimeout(()=>div.remove(),1000);
}

function createFloatingNumberFromElem(elem,text){
 const rect = elem.getBoundingClientRect();
 createFloatingNumber(rect.left + rect.width/2, rect.top, text);
}

function showOfflinePopup(text){
 offlinePopup.textContent = text;
 offlinePopup.style.display = 'block';
 offlinePopup.style.opacity = '1';
 // show for 5 seconds then hide
 setTimeout(()=>{
   offlinePopup.style.transition = 'opacity 0.6s ease';
   offlinePopup.style.opacity = '0';
   setTimeout(()=> offlinePopup.style.display = 'none', 600);
 },5000);
}


// --- Update UI ---
function updateUI(){
 counter.textContent=formatNumber(score)+" Cookies";
 let cps = getTotalCPS();
 cpsCounter.textContent=formatNumber(cps)+" cookies/sec";
 renderShop();
 renderCursors();
 updateStats();
}


// --- Shop ---
function renderShop(){
 shopItemsDiv.innerHTML="";
 items.forEach((item,i)=>{
   const div=document.createElement("div");
   div.className="shopItem";
   div.textContent=`${item.name} - CPS: ${formatNumber(item.cps)} - Cost: ${formatNumber(Math.floor(item.cost))} - Owned: ${formatNumber(item.owned)}`;
   div.onclick=()=>buyItem(i, div);
   shopItemsDiv.appendChild(div);
 });
}


function buyItem(i, elem){
 // buy one at a time (prevents giant while loops). Auto-buy loop may call repeatedly.
 if(score>=items[i].cost){
   score-=items[i].cost;
   items[i].owned++;
   items[i].cost=Math.floor(items[i].cost*1.15);
   createFloatingNumberFromElem(elem, "+Item");
   updateUI();
 }
}


// --- Click Cookie ---
clickImgElem.addEventListener("click",(e)=>{
 const clickValue = baseClickValue * clickMultiplier * rebirthMult;
 score+=clickValue;
 totalCookies+=clickValue;
 clicksMade++;
 createFloatingNumber(e.clientX,e.clientY,"+"+formatNumber(clickValue));
 updateUI();
});


// --- Smooth CPS Loop ---
const fps = 60;
setInterval(() => {
   if(freezeCPS) return;
   let cps = getTotalCPS();
   cps *= cpsMultiplier; // apply any frenzy multiplier
   let increment = cps / fps;
   score += increment;
   totalCookies += increment;
   updateUI();
}, 1000 / fps);


// --- Upgrades ---
function toggleUpgrades(){
 upgradesPanel.style.display=upgradesPanel.style.display==="none"?"block":"none";
 renderUpgrades();
}
function renderUpgrades(){
 upgradesPanel.innerHTML="";
 [...generalUpgrades,...itemUpgrades].forEach(up=>{
   if(!up.applied){
     const div=document.createElement("div");
     div.className="upgradeItem";
     div.textContent=`${up.name} - Cost: ${formatNumber(Math.floor(up.cost))}`;
     div.onclick=()=>{
       if(score>=up.cost){
         score-=up.cost;
         up.applied=true;
         up.effect();
         createFloatingNumberFromElem(div, "+Upgrade");
         updateUI();
       }
     };
     upgradesPanel.appendChild(div);
   }
 });
}


// --- Player Name ---
function setName(){
 playerName=playerNameInput.value;
 if(playerName.toLowerCase()==="hjalmarprimemode") adminPanelElem.style.display="block";
 else adminPanelElem.style.display="none";
 alert("Welcome, "+playerName+"!");
}


// --- Prestige ---
function prestige(){
 let points=Math.floor(score/100000);
 if(points>0){
   prestigePoints+=points;
   score=0;
   // reset items to base state
   items.forEach(it=>{ it.owned=0; it.cps = it.baseCps; it.cost = it.baseCost; });
   // reset upgrades
   itemUpgrades.forEach(up=>up.applied=false);
   generalUpgrades.forEach(up=>up.applied=false);
   baseClickValue = 1;
   cpsExtraBase = 0;
   clickMultiplier = 1;
   cpsMultiplier = 1;
   createFloatingNumber(window.innerWidth/2,150,"+Prestige");
   updateUI();
   alert(`You gained ${points} prestige points!`);
 }else alert("You need more cookies to gain prestige!");
}


// --- Stats ---
function updateStats(){
 document.getElementById("totalCookiesStat").textContent="Total Cookies: "+formatNumber(totalCookies);
 document.getElementById("clicksStat").textContent="Total Clicks: "+clicksMade;
 document.getElementById("prestigeStat").textContent="Prestige Points: "+prestigePoints;
}


// --- Admin Functions ---
function adminAddCustomCookies(){let val=parseFloat(prompt("Enter amount to add:")); if(!isNaN(val)){score+=val; updateUI();}}
function adminRemoveCookies(){let val=parseFloat(prompt("Enter amount to remove:")); if(!isNaN(val)){score-=val; if(score<0) score=0; updateUI();}}
function adminMultiplyCookies(){score*=10; updateUI();}
function adminSetCPS(){let val=parseFloat(prompt("Set CPS to:")); if(!isNaN(val)) cpsExtraBase=val;}
function adminGiveAllItems(){items.forEach(it=>it.owned+=10); updateUI();}
function adminMaxUpgrades(){[...generalUpgrades,...itemUpgrades].forEach(up=>{if(!up.applied){up.applied=true;up.effect();}}); updateUI();}
function startClickFrenzy(){if(!clickFrenzyActive){clickFrenzyActive=true; clickMultiplier*=777; setTimeout(stopClickFrenzy,30000);}}
function stopClickFrenzy(){if(clickFrenzyActive){clickFrenzyActive=false; clickMultiplier/=777;}}
function startCookieFrenzy(){if(!cookieFrenzyActive){cookieFrenzyActive=true; cpsMultiplier*=100; setTimeout(stopCookieFrenzy,30000);}}
function stopCookieFrenzy(){if(cookieFrenzyActive){cookieFrenzyActive=false; cpsMultiplier/=100;}}
function adminAddPrestige(){let val=parseInt(prompt("Add prestige points:")); if(!isNaN(val)){prestigePoints+=val; updateStats();}}
function toggleAutoBuy(){autoBuyItems=!autoBuyItems;}
function toggleAutoUpgrade(){autoBuyUpgrades=!autoBuyUpgrades;}
function toggleFreeze(){freezeCPS=!freezeCPS;}
function resetGame(){if(confirm("Reset all progress?")) { localStorage.removeItem('snusGameState'); location.reload(); }}


// --- Auto-buy loop ---
setInterval(()=>{
 if(autoBuyItems) items.forEach((it,i)=>{ if(score>=it.cost) buyItem(i); });
 if(autoBuyUpgrades) [...generalUpgrades,...itemUpgrades].forEach(up=>{if(!up.applied && score>=up.cost){score-=up.cost; up.applied=true; up.effect(); updateUI();}});
},500);


// ---------- Offline accumulation (timestamp) ----------
function getTotalCPS(){
  // total cps from items + any extra base
  return items.reduce((acc, it) => acc + it.cps * it.owned, 0) + cpsExtraBase;
}

function saveGameState(){
  const state = {
    score,
    totalCookies,
    clicksMade,
    prestigePoints,
    items: items.map(it => ({name: it.name, owned: it.owned, cost: it.cost})),
    itemUpgrades: itemUpgrades.map(u => ({name: u.name, applied: u.applied})),
    generalUpgrades: generalUpgrades.map(u => ({name: u.name, applied: u.applied})),
    baseClickValue,
    cpsExtraBase,
    lastSaved: Date.now()
  };
  try {
    localStorage.setItem('snusGameState', JSON.stringify(state));
  } catch (e){
    console.warn('Failed to save state', e);
  }
}

function loadGameState(){
  try{
    const raw = localStorage.getItem('snusGameState');
    if(!raw) return;
    const state = JSON.parse(raw);

    // restore base primitive state
    score = state.score ?? score;
    totalCookies = state.totalCookies ?? totalCookies;
    clicksMade = state.clicksMade ?? clicksMade;
    prestigePoints = state.prestigePoints ?? prestigePoints;
    baseClickValue = state.baseClickValue ?? baseClickValue;
    cpsExtraBase = state.cpsExtraBase ?? cpsExtraBase;

    // reset items to base then restore owned & cost
    items.forEach(it => { it.cps = it.baseCps; it.cost = it.baseCost; });
    if(state.items && Array.isArray(state.items)){
      state.items.forEach(savedItem => {
        const it = items.find(x => x.name === savedItem.name);
        if(it){ it.owned = savedItem.owned ?? it.owned; it.cost = savedItem.cost ?? it.cost; }
      });
    }

    // restore applied flags (but do NOT call effects yet)
    if(state.itemUpgrades && Array.isArray(state.itemUpgrades)){
      state.itemUpgrades.forEach(savedUp => {
        const up = itemUpgrades.find(u => u.name === savedUp.name);
        if(up) up.applied = !!savedUp.applied;
      });
    }
    if(state.generalUpgrades && Array.isArray(state.generalUpgrades)){
      state.generalUpgrades.forEach(savedUp => {
        const up = generalUpgrades.find(u => u.name === savedUp.name);
        if(up) up.applied = !!savedUp.applied;
      });
    }

    // now re-apply all upgrade effects (reset cps to base first to avoid stacking twice)
    items.forEach(it => it.cps = it.baseCps);
    [...generalUpgrades,...itemUpgrades].forEach(up => { if(up.applied) up.effect(); });

    // now compute offline gain since lastSaved
    if(state.lastSaved){
      const now = Date.now();
      const elapsedMs = Math.max(0, now - state.lastSaved);
      const elapsedSec = elapsedMs / 1000;
      const cps = getTotalCPS() * (cpsMultiplier); // include current multiplier (should be 1 normally)
      const gain = cps * elapsedSec;
      if(gain > 0){
        score += gain;
        totalCookies += gain;
        // show offline popup for 5 seconds
        showOfflinePopup('+' + formatNumber(gain) + ' (offline)');
      }
    }

  }catch(e){
    console.warn('Failed to load state', e);
  }
}

// Save on unload / visibilitychange
window.addEventListener('beforeunload', saveGameState);
document.addEventListener('visibilitychange', () => {
  if(document.visibilityState === 'hidden'){
    saveGameState();
  } else {
    // when regaining visibility we can also load to be safe
    loadGameState();
    updateUI();
  }
});

// load on start
loadGameState();

// --- Initial Update ---
updateUI();
</script>
</body>
</html>
